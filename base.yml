---
- hosts: localhost # hostname
  sudo: no
  gather_facts: no
  vars:
      ruby_version: "2.1.5"

  tasks:

    - name: Taps
      homebrew_tap: tap={{item}}
      with_items:
          - homebrew/versions
          - caskroom/cask
          - caskroom/versions
          - homebrew/php

    - name: Install homebrew-cask
      homebrew: name=brew-cask

    - name: Install GUI Applications
      homebrew_cask: name={{item}}
      environment:
        HOMEBREW_CASK_OPTS: "--appdir=/Applications"
      with_items:
          - dropbox
          - owncloud
          - iterm2
          - google-japanese-ime
          - bettertouchtool
          - menumeters
          - karabiner
          - evernote
          - macvim-kaoriya
          - flash
          - java
          - cyberduck
          - virtualbox
          - vagrant
          - vagrant-manager
          - mysqlworkbench
          - bartender
          - vlc
          - rescuetime
          - cocoarestclient
          - adobe-air
          - cacoo-ninja
          - github
          - day-o
          - onyx
          - heroku-toolbelt
          - xquartz
          - firefox
          - google-chrome
          - goofy
          - libreoffice
          - kobito
          - kindle
          - lastfm
          - fluid
          - chefdk
          - alfred
          - fabric
          - google-drive

    - name: Install Basic Components
      homebrew: name={{item}} 
      with_items:
          - vim
          - cloog
          - gcc
          - pwgen
          - tree
          - git
          - bash
          - trash
          - wget
          - imagemagick
          - ghostscript
          - bash-completion
          - watch
          - nkf
          - nmap
          - awscli
          - ansible
          - mysql
          - postgresql
          - node

    - name: Create Path to gcc and g++
      file: src=/usr/local/bin/{{item}}-4.9 dest=/usr/local/bin/{{item}}
          state=link
      with_items: [gcc, g++]

    - name: Install PHPs
      homebrew: name={{item}}
      with_items:
          - php56
          - composer
          - php56-mcrypt

    - name: Install Rubys
      homebrew: name={{item}}
      with_items: 
          - ruby-build
          - rbenv

    # Install Ruby
    - name: Check installed Ruby version
      shell: "rbenv versions | grep {{ruby_version}} > /dev/null ; echo $?"
      ignore_errors: true
      register: ruby_is_installed 
      changed_when: ruby_is_installed.stdout != '0'

    - name: Install Ruby
      shell: "rbenv install {{ruby_version}}"
      when: ruby_is_installed.stdout != '0'

    # Switch Ruby version
    - name: Check Ruby version
      shell: "ruby -v | grep {{ruby_version}} > /dev/null ; echo $?"
      register: is_correct_version
      changed_when: is_correct_version.stdout != '0'

    - name: Switch Ruby version
      shell: "rbenv global {{ruby_version}} && rbenv rehash"
      when: is_correct_version.stdout != '0'

    # TODO: ここでrbenvの初期化をする必要がある（シェルの立ち上げ直し）

    - name: Install Gems
      gem: name={{item}} user_install=false
      # user_install=falseで~/.rbenv/...にインストールされる
      with_items:
          - rails
          - bundler
          - serverspec
          - cocoapods
          - tw

    - name: Uninstall gems
      gem: name={{item}} user_install=false state=absent
      with_items:
          - chef
          - chef-zero
          - knife-solo
          - berkshelf
          - kitchen-vagrant
          - test-kitchen
          - knife-solo_data_bag

    # - name: Check Installed vagrant plugins
    #   shell: "vagrant plugin list | cut -d ' ' -f1"
    #   register: installed_vagrant_plugins
    #   changed_when: installed_vagrant_plugins.rc != 0
    #   # rc returns exit code

    - name: Install Node related packages
      npm: name={{item}} global=yes
      with_items:
          - jshint

    - name: List Installed Vagrant Plugins
      shell: "vagrant plugin list | awk '{ print $1 }'"
      changed_when: false
      register: vagrant_plugin_list

    - name: Install Vagrant Plugins
      shell: "vagrant plugin install {{item}}"
      with_items:
        - vagrant-omnibus
        - vagrant-vbguest
        - vagrant-cachier
        - vagrant-vbox-snapshot
        - vagrant-aws
        - vagrant-digitalocean
      when: item not in vagrant_plugin_list.stdout_lines

    - name: Create iCloud Drive Directory
      file: path=~/iCloud\ Drive state=directory
    - name: Create iCloud Drive Symlinks
      file: src=~/Library/Mobile\ Documents/com~apple~{{item}}/Documents
            dest=~/iCloud\ Drive/{{item}} state=link
      with_items:
          - Keynote
          - Numbers
          - Pages
          - Automator
          - Notes
          - Preview
          - TextEdit
          - QuickTimePlayerX
          - ScriptEditor2

    - file: src=~/Library/Mobile\ Documents/com~apple~CloudDocs
            dest=~/iCloud\ Drive/CloudDocs state=link



