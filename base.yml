---
- hosts: localhost # hostname
  sudo: no
  vars:
      ruby_version: "2.1.5"

  tasks:

    - name: Taps
      homebrew_tap: tap={{item}}
      with_items:
          - homebrew/versions
          - caskroom/cask
          - caskroom/versions
          - homebrew/php

    - name: Install homebrew-cask
      homebrew: name=brew-cask

    - name: Install GUI Applications
      homebrew_cask: name={{item}}
      environment:
        HOMEBREW_CASK_OPTS: "--appdir=/Applications"
      with_items:
          - dropbox
          - owncloud
          - iterm2
          - google-japanese-ime
          - bettertouchtool
          - menumeters 
          - karabiner
          - evernote 
          - macvim-kaoriya
          - flash
          - java
          - cyberduck
          - virtualbox
          - vagrant
          - mysqlworkbench
          - bartender
          - vlc
          - rescuetime
          - cocoarestclient
          - adobe-air
          - cacoo-ninja
          - mendeley-desktop
          - github
          - day-o
          - onyx
          - heroku-toolbelt
          - xquartz
          - firefox
          - google-chrome
          - goofy
          - libreoffice
          - kobito
          - duet
          - kindle
          - lastfm
          # - recordit
          # - mactex

    - name: Install Basic Components
      homebrew: name={{item}} 
      with_items:
          - vim
          - cloog
          - gcc
          - pwgen
          - tree
          - git
          - bash
          - trash
          - wget
          - imagemagick
          - ghostscript
          - bash-completion
          - watch
          - nkf
          - nmap
          - awscli
          - ansible
          - postgresql

    - name: Install PHPs
      homebrew: name={{item}}
      with_items:
          - php56
          - composer
          - php56-mcrypt

    - name: Install Rubys
      homebrew: name={{item}}
      with_items: 
          - ruby-build
          - rbenv

    # Install Ruby
    - name: Check installed Ruby version
      shell: "rbenv versions | grep {{ruby_version}} > /dev/null ; echo $?"
      ignore_errors: true
      register: ruby_is_installed 
      changed_when: ruby_is_installed.stdout != '0'

    - name: Install Ruby
      shell: "rbenv install {{ruby_version}}"
      when: ruby_is_installed.stdout != '0'

    # Switch Ruby version
    - name: Check Ruby version
      shell: "ruby -v | grep {{ruby_version}} > /dev/null ; echo $?"
      register: is_correct_version
      changed_when: is_correct_version.stdout != '0'

    - name: Switch Ruby version
      shell: "rbenv global {{ruby_version}} && rbenv rehash"
      when: is_correct_version.stdout != '0'

    - name: Install Gems
      gem: name={{item}} user_install=false
      # user_install=falseで~/.rbenv/...にインストールされる
      with_items:
          - rails
          - bundler
          - chef
          - chef-zero
          - knife-solo
          - berkshelf
          - kitchen-vagrant
          - test-kitchen
          - knife-solo_data_bag
          - serverspec
          - cocoapods
          - tw

    # - name: Check Installed vagrant plugins
    #   shell: "vagrant plugin list | cut -d ' ' -f1"
    #   register: installed_vagrant_plugins
    #   changed_when: installed_vagrant_plugins.rc != 0
    #   # rc returns exit code
        
    - name: Install Vagrant Plugins
      shell: "vagrant plugin list | grep {{item}} || vagrant plugin install {{item}}"
      with_items:
          - vagrant-omnibus
          - vagrant-vbguest
          - vagrant-cachier
          - vagrant-vbox-snapshot

    
    - name: Check System Languages
      # not 'command'!
      shell: "defaults read .GlobalPreferences AppleLanguages -array en ja | tr -d '\n' | tr -d ' '"
      register: langs
      changed_when: langs.stdout != '(en,ja)'

    - name: Change System Languages
      shell: "defaults write .GLobalPreferences AppleLanguages -array en ja"
      when: langs.stdout != '(en,ja)'

